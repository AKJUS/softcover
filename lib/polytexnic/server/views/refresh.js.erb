wait = ->
  $.ajax
    url: window.location.pathname + '/wait'
    dataType: 'json'
    timeout: 29 * 1000
    success: ->
      $.get window.location.pathname + '.js', (html)->
        $('#book').html html
        initMathJax()
        wait()
    error: (jqXHR, textStatus)->
      if textStatus == 'timeout'
        # polling end, reconnect immediately
        wait()
      else
        # server down, try reconnecting again after timeout
        setTimeout wait, 5000

initMathJax = ->
  $('#mathJaxJS').remove()
  delete MathJax

  chapter_number = $('.chapter').attr('data-number')
  script = document.createElement( 'script' )
  script.id = 'mathJaxJS'
  script.type = 'text/javascript'
  script.src = '<%= @mathjax_src %>'
  script.innerHTML = """
    <%= @mathjax_config %>
    """

  $('head').append script

$ ->
  initMathJax()
  wait()
